#!/bin/bash
# Ver playlist del daemon you-tui con interfaz interactiva

# Verificar si el daemon est√° corriendo
if ! pgrep -f you-tui-daemon > /dev/null 2>&1; then
    echo "‚ùå Daemon not running"
    echo "   Start with: you-tui-daemon"
    exit 1
fi

# Obtener playlist
STATUS=$(echo '{"command":"GetStatus"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock 2>/dev/null)

if [ -z "$STATUS" ]; then
    echo "‚ùå No response from daemon"
    exit 1
fi

# Parse and display with fzf
echo "$STATUS" | python3 -c "
import sys, json

data = sys.stdin.read().lstrip('\ufeff')
result = json.loads(data)
d = result.get('Data', {})
queue = d.get('Queue', [])
current_idx = d.get('CurrentIndex', 0)
is_playing = d.get('IsPlaying', False)

if not queue:
    print('üìã Playlist is empty', file=sys.stderr)
    sys.exit(1)

# Calculate total duration
total_seconds = 0
for track in queue:
    dur_str = track['Duration']
    parts = dur_str.split(':')
    if len(parts) == 2:
        mins, secs = int(parts[0]), int(parts[1])
        total_seconds += mins * 60 + secs

total_mins = total_seconds // 60
total_secs = total_seconds % 60

# Output header info for preview
print(f'HEADER¬ß¬ß¬ß{len(queue)}¬ß¬ß¬ß{total_mins}:{total_secs:02d}¬ß¬ß¬ß{current_idx}¬ß¬ß¬ß{\"‚ñ∂Ô∏è\" if is_playing else \"‚è∏Ô∏è\"}')

# Output each track for selection
for i, track in enumerate(queue):
    marker = '‚ñ∂' if i == current_idx else ' '
    status = '‚óè' if i == current_idx and is_playing else '‚óã' if i == current_idx else ' '
    
    # Format: index¬ß¬ß¬ßmarker¬ß¬ß¬ßstatus¬ß¬ß¬ßtitle¬ß¬ß¬ßuploader¬ß¬ß¬ßduration
    print(f'{i}¬ß¬ß¬ß{marker}¬ß¬ß¬ß{status}¬ß¬ß¬ß{track[\"Title\"]}¬ß¬ß¬ß{track[\"Uploader\"]}¬ß¬ß¬ß{track[\"Duration\"]}')
" | {
    # Read header
    IFS= read -r header_line
    
    # Extract header info using parameter expansion
    rest="$header_line"
    rest="${rest#*¬ß¬ß¬ß}"  # Skip HEADER
    total_tracks="${rest%%¬ß¬ß¬ß*}"
    rest="${rest#*¬ß¬ß¬ß}"
    total_duration="${rest%%¬ß¬ß¬ß*}"
    rest="${rest#*¬ß¬ß¬ß}"
    current_idx="${rest%%¬ß¬ß¬ß*}"
    rest="${rest#*¬ß¬ß¬ß}"
    play_status="$rest"
    
    # Create header for fzf
    HEADER="‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üéµ Playlist: $total_tracks tracks ‚îÇ ‚è±Ô∏è  Total: $total_duration ‚îÇ Status: $play_status                  ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Press ENTER to jump to track ‚îÇ ESC to exit                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    
    # Format tracks for fzf
    cat | awk -F'¬ß¬ß¬ß' '{
        idx = $1
        marker = $2
        status = $3
        title = $4
        uploader = $5
        duration = $6
        
        # Color codes
        if (marker == "‚ñ∂") {
            # Currently playing track - bold green
            printf "\033[1;32m%s %s %2d. %-50s\033[0m \033[2;37m%-30s %s\033[0m¬ß¬ß¬ß%s\n", marker, status, idx+1, substr(title, 1, 50), substr(uploader, 1, 30), duration, idx
        } else {
            # Other tracks - gray
            printf "\033[2;37m%s %s %2d.\033[0m %-50s \033[2;37m%-30s %s\033[0m¬ß¬ß¬ß%s\n", marker, status, idx+1, substr(title, 1, 50), substr(uploader, 1, 30), duration, idx
        }
    }' | fzf \
        --ansi \
        --reverse \
        --no-sort \
        --header="$HEADER" \
        --prompt="üéµ Select track: " \
        --pointer="‚ñ∂" \
        --color="header:italic:white,prompt:bold:blue,pointer:bold:green,marker:bold:red" \
        --preview-window=hidden \
        --height=100% \
        --bind="esc:cancel"
}

# Get result - fzf outputs the full line
RESULT=$?

# Read the output
SELECTED_LINE=$(cat)

if [ $RESULT -eq 130 ]; then
    # User pressed ESC
    exit 0
fi

if [ -n "$SELECTED_LINE" ]; then
    # Extract index from end of line
    TRACK_IDX="${SELECTED_LINE##*¬ß¬ß¬ß}"
    echo ""
    echo "‚è≠Ô∏è  Jumping to track $(($TRACK_IDX + 1))..."
    
    # Send JumpTo command
    echo "{\"command\":\"JumpTo\",\"data\":{\"Index\":$TRACK_IDX}}" | \
        socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Now playing track $(($TRACK_IDX + 1))"
    else
        echo "‚ùå Failed to jump to track"
        exit 1
    fi
fi
"
