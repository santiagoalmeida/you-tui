#!/bin/bash
# you-tui - YouTube Terminal Music Player
# Main command with subcommands

COMMAND="${1:-}"

case "$COMMAND" in
    start)
        echo "üöÄ Starting you-tui daemon..."
        systemctl --user start you-tui-daemon
        sleep 1
        if systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚úÖ Daemon started successfully"
            PID=$(pgrep -f you-tui-daemon 2>/dev/null)
            echo "   PID: $PID"
        else
            echo "‚ùå Failed to start daemon"
            systemctl --user status you-tui-daemon
            exit 1
        fi
        ;;
    
    stop)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ö†Ô∏è  Daemon is not running"
            exit 0
        fi
        echo "‚èπÔ∏è  Stopping you-tui daemon..."
        systemctl --user stop you-tui-daemon
        sleep 1
        if systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Failed to stop daemon"
            exit 1
        else
            echo "‚úÖ Daemon stopped successfully"
        fi
        ;;
    
    restart)
        echo "üîÑ Restarting you-tui daemon..."
        systemctl --user restart you-tui-daemon
        sleep 1
        if systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚úÖ Daemon restarted successfully"
            PID=$(pgrep -f you-tui-daemon 2>/dev/null)
            echo "   PID: $PID"
        else
            echo "‚ùå Failed to restart daemon"
            systemctl --user status you-tui-daemon
            exit 1
        fi
        ;;
    
    status)
        exec you-tui-status
        ;;
    
    playlist)
        exec you-tui-playlist
        ;;
    
    play)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        echo '{"command":"Play"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "‚ñ∂Ô∏è  Playing"
        else
            echo "‚ùå Failed to send play command"
            exit 1
        fi
        ;;
    
    pause)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        echo '{"command":"Pause"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "‚è∏Ô∏è  Paused"
        else
            echo "‚ùå Failed to send pause command"
            exit 1
        fi
        ;;
    
    next)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        echo '{"command":"Next"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "‚è≠Ô∏è  Next track"
        else
            echo "‚ùå Failed to send next command"
            exit 1
        fi
        ;;
    
    prev|previous|back)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        echo '{"command":"Previous"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "‚èÆÔ∏è  Previous track"
        else
            echo "‚ùå Failed to send previous command"
            exit 1
        fi
        ;;
    
    search)
        shift
        QUERY="$*"
        if [ -z "$QUERY" ]; then
            echo "Usage: you-tui search <query>"
            echo "Example: you-tui search toto africa"
            exit 1
        fi
        
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        
        echo "üîç Searching for: $QUERY"
        echo ""
        
        # Search and let user select with fzf
        yt-dlp --no-warnings -J --flat-playlist "ytsearch20:$QUERY" 2>/dev/null | \
        python3 -c "
import sys, json

try:
    data = json.load(sys.stdin)
    entries = data.get('entries', [])
    
    if not entries:
        print('‚ùå No results found', file=sys.stderr)
        sys.exit(1)
    
    # Output in format for fzf: title|channel|duration|id
    for entry in entries:
        title = entry.get('title', 'Unknown')
        channel = entry.get('channel', entry.get('uploader', 'Unknown'))
        duration = entry.get('duration', 0)
        video_id = entry.get('id', '')
        
        # Format duration
        if duration:
            mins = int(duration // 60)
            secs = int(duration % 60)
            dur_str = f'{mins:02d}:{secs:02d}'
        else:
            dur_str = '??:??'
        
        # Output: display text|json data
        display = f'{title} | {channel} | {dur_str}'
        json_data = json.dumps({
            'Id': video_id,
            'Title': title,
            'Uploader': channel,
            'Duration': dur_str,
            'Url': f'https://www.youtube.com/watch?v={video_id}',
            'Thumbnail': entry.get('thumbnail', '')
        })
        print(f'{display}|||{json_data}')
        
except Exception as e:
    print(f'‚ùå Error: {e}', file=sys.stderr)
    sys.exit(1)
" | fzf --multi \
    --prompt="Select tracks to add (TAB for multi-select, ENTER to add): " \
    --preview='echo {}' \
    --preview-window=hidden \
    --height=~100% \
    --header="Search results for: $QUERY" | \
while IFS='|||' read -r display data; do
    echo "‚ûï Adding: $(echo "$display" | cut -d'|' -f1)"
    
    # Send AddTrack command - data is already JSON, wrap it properly
    echo "$data" | python3 -c "
import sys, json
track = json.load(sys.stdin)
command = {
    'command': 'AddTrack',
    'data': {'Track': track}
}
print(json.dumps(command))
" | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "   ‚úÖ Added successfully"
    else
        echo "   ‚ùå Failed to add"
    fi
done

ADDED=$?
if [ $ADDED -eq 0 ]; then
    echo ""
    echo "‚úÖ Tracks added to playlist"
fi
        ;;
    
    clear)
        if ! systemctl --user is-active --quiet you-tui-daemon; then
            echo "‚ùå Daemon is not running. Start it with: you-tui start"
            exit 1
        fi
        
        echo "üóëÔ∏è  Clearing playlist..."
        echo '{"command":"ClearQueue"}' | socat - UNIX-CONNECT:/tmp/you-tui-daemon.sock > /dev/null 2>&1
        
        if [ $? -eq 0 ]; then
            echo "‚úÖ Playlist cleared"
        else
            echo "‚ùå Failed to clear playlist"
            exit 1
        fi
        ;;
    
    help|--help|-h)
        cat << 'EOF'
you-tui - YouTube Terminal Music Player

Usage:
  you-tui [command]

Commands:
  (none)        Launch interactive client
  
Daemon Control:
  start         Start the daemon
  stop          Stop the daemon
  restart       Restart the daemon
  
Playback Control:
  play          Resume playback
  pause         Pause playback
  next          Skip to next track
  prev          Go to previous track
  
Playlist Management:
  search <q>    Search for songs and add to playlist (interactive)
  clear         Clear the playlist
  
Information:
  status        Show current playback status
  playlist      Show current playlist
  help          Show this help message

Examples:
  you-tui                      # Launch interactive client
  you-tui start                # Start daemon
  you-tui search toto africa   # Search for songs
  you-tui status               # Show what's playing
  you-tui next                 # Skip to next track
  you-tui clear                # Clear playlist

For more information, visit: https://github.com/santiagoalmeida/you-tui
EOF
        ;;
    
    *)
        # No command or unknown command - launch client
        exec /usr/local/bin/you-tui-client "$@"
        ;;
esac
